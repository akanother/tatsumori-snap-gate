import{g as y,f as r,o as c,b as s,h as g,t as d,e as u,n as p,F as v,k as w,m as x,p as h,d as k}from"./app-Fz5_94mT.js";import{_}from"./_plugin-vue_export-helper-DlAUqK2U.js";const C={name:"Capture",components:{Head:y},props:{roomCode:{type:String,default:""},maxFiles:{type:Number,default:10},maxMB:{type:Number,default:20},uploadUrl:{type:String,required:!0},logoutUrl:{type:String,required:!0},expiresAt:{type:String,default:null},csrfToken:{type:String,required:!0}},data(){return{files:[],uploading:!1,progress:0,result:null,camera:{open:!1,facing:"environment",busy:!1,stream:null},pingTimer:null}},computed:{maxBytes(){return this.maxMB*1024*1024},totalBytes(){return this.files.reduce((e,t)=>{var a;return e+(((a=t.file)==null?void 0:a.size)||0)},0)},okToUpload(){return!(this.files.length===0||this.files.length>this.maxFiles||this.files.some(e=>e.tooBig))},humanExp(){if(!this.expiresAt)return"";try{const e=new Date(this.expiresAt),t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0");return`${t}/${a}/${o} ${i}:${n}`}catch{return this.expiresAt}}},mounted(){this.pingTimer=setInterval(async()=>{try{await fetch("/gate/ping",{method:"GET",credentials:"same-origin",cache:"no-store"})}catch{}},6e4)},beforeUnmount(){this.pingTimer&&clearInterval(this.pingTimer),this.files.forEach(e=>e.url&&URL.revokeObjectURL(e.url)),this.closeCamera()},methods:{async onPick(e){const t=Array.from(e.target.files||[]);if(!t.length)return;const a=Math.max(this.maxFiles-this.files.length,0),o=t.slice(0,a);for(const i of o){const n=await this.maybeCompress(i);this.pushFile(n,i.name)}this.$refs.fileInput.value="",this.toast(`追加: ${o.length} 枚`)},pushFile(e,t){const a=this.safeName(t,"jpg"),o=new File([e],a,{type:e.type||"image/jpeg"}),i=/image\/(jpeg|png|webp)/.test(o.type),n=o.size>this.maxBytes;this.files.push({id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,file:o,url:i?URL.createObjectURL(o):"",previewable:i,tooBig:n})},removeAt(e){const t=this.files[e];t!=null&&t.url&&URL.revokeObjectURL(t.url),this.files.splice(e,1)},clearAll(){this.files.forEach(e=>e.url&&URL.revokeObjectURL(e.url)),this.files=[],this.result=null,this.progress=0},async upload(){var t;if(!this.okToUpload||this.uploading)return;this.uploading=!0,this.progress=0,this.result=null;const e=new FormData;this.files.forEach(a=>e.append("images[]",a.file)),e.append("_token",this.csrfToken);try{const a=await this.xhrPost(this.uploadUrl,e,i=>{i.lengthComputable&&(this.progress=Math.min(100,Math.round(i.loaded/i.total*100)))});if(!a.ok){const i=await this.safeJson(a);throw new Error((i==null?void 0:i.message)||`HTTP ${a.status}`)}this.result=await a.json();const o=((t=this.result)==null?void 0:t.count)??this.files.length;this.clearAll(),await h.fire({icon:"success",title:"アップロード完了",html:`<div style="line-height:1.6">保存数：<b>${o}</b> 点<br>ご協力ありがとうございます。</div>`,confirmButtonText:"OK"})}catch(a){console.error(a),h.fire({icon:"error",title:"アップロードに失敗しました",text:a&&a.message?String(a.message):"未知のエラーです",confirmButtonText:"閉じる"})}finally{this.uploading=!1,this.progress=0}},xhrPost(e,t,a){return new Promise((o,i)=>{const n=new XMLHttpRequest;n.open("POST",e),n.responseType="json",n.setRequestHeader("X-CSRF-TOKEN",this.csrfToken),n.upload.onprogress=a,n.onload=()=>{o({ok:n.status>=200&&n.status<300,status:n.status,json:async()=>n.response})},n.onerror=()=>i(new Error("ネットワークエラー")),n.send(t)})},async safeJson(e){try{return await e.json()}catch{return null}},onLogoutClick(){if(confirm("退出するとこのセッションは終了します。よろしいですか？")){try{history.replaceState(null,"","/gate/ended")}catch{}this.$refs.logoutForm.submit()}},toast(e="完了",t="success"){return h.mixin({toast:!0,position:"top",showConfirmButton:!1,timer:1800,timerProgressBar:!0}).fire({icon:t,title:e})},async openCamera(){var e;if(!((e=navigator.mediaDevices)!=null&&e.getUserMedia)){h.fire({icon:"info",title:"カメラ非対応",text:"写真の選択をご利用ください。"});return}try{this.camera.busy=!0;const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:this.camera.facing,width:{ideal:1920},height:{ideal:1080}},audio:!1});this.camera.stream=t,this.camera.open=!0,await this.$nextTick();const a=this.$refs.videoRef;a.srcObject=t,await a.play()}catch(t){console.error(t),h.fire({icon:"error",title:"カメラを起動できません",text:"権限設定をご確認ください。"})}finally{this.camera.busy=!1}},async closeCamera(){this.camera.stream&&(this.camera.stream.getTracks().forEach(e=>e.stop()),this.camera.stream=null),this.camera.open=!1},async toggleFacing(){this.camera.facing=this.camera.facing==="environment"?"user":"environment",await this.closeCamera(),await this.openCamera()},async shoot(){if(!this.camera.open)return;const e=this.$refs.videoRef,t=e.videoWidth||1280,a=e.videoHeight||720,o=document.createElement("canvas"),{tw:i,th:n}=this.fitWithin(t,a,2e3,2e3);o.width=i,o.height=n,o.getContext("2d").drawImage(e,0,0,i,n);let m=.92,f=await this.canvasToBlob(o,"image/jpeg",m);for(;f.size>this.maxBytes&&m>.5;)m-=.08,f=await this.canvasToBlob(o,"image/jpeg",m);const b=`camera_${this.ts()}_${Math.random().toString(36).slice(2,8)}.jpg`;this.pushFile(f,b),this.toast("撮影しました")},safeName(e,t="jpg"){return(e||"").replace(/[^\w.\-]+/g,"_")||`image_${this.ts()}.${t}`},ts(){const e=new Date,t=a=>String(a).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}_${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`},fitWithin(e,t,a,o){const i=Math.min(a/e,o/t,1);return{tw:Math.round(e*i),th:Math.round(t*i)}},canvasToBlob(e,t,a){return new Promise(o=>e.toBlob(i=>o(i),t,a))},async maybeCompress(e){if(/image\/(heic|heif)/i.test(e.type))return e;try{const t=await this.readImage(e),{tw:a,th:o}=this.fitWithin(t.width,t.height,2e3,2e3),i=document.createElement("canvas");i.width=a,i.height=o,i.getContext("2d").drawImage(t,0,0,a,o);let l=.92,m=await this.canvasToBlob(i,"image/jpeg",l);for(;m.size>this.maxBytes&&l>.5;)l-=.08,m=await this.canvasToBlob(i,"image/jpeg",l);return m}catch(t){return console.warn("compress failed, use original",t),e}},readImage(e){return new Promise((t,a)=>{const o=URL.createObjectURL(e),i=new Image;i.onload=()=>{URL.revokeObjectURL(o),t(i)},i.onerror=n=>{URL.revokeObjectURL(o),a(n)},i.src=o})}}},T={class:"bg-gray-50 min-h-screen d-flex flex-column"},B={class:"p-3 bg-white shadow-sm d-flex align-items-center justify-content-between sticky-top"},S={class:"text-muted"},U={class:"container py-3 with-footer",style:{"max-width":"640px"}},j={key:0,class:"alert alert-info py-2 px-3 mb-3"},M={class:"card mb-3"},F={class:"card-body py-3"},R={class:"small mb-0 text-muted ps-3"},L={class:"card mb-3"},A={class:"card-body d-grid gap-2"},E=["disabled"],O={class:"btn btn-primary btn-lg py-3 w-100 mb-0"},P={key:1,class:"card mb-3"},I={class:"card-body py-3"},D={class:"d-flex justify-content-between align-items-center"},N={class:"text-muted small ms-2"},q={key:2,class:"mb-3"},z={class:"row g-2"},H={class:"thumb border rounded overflow-hidden"},W=["src","alt"],K={key:1,class:"thumb-fallback"},V=["onClick","disabled","aria-label"],G={key:3,class:"mb-3"},J={class:"progress",style:{height:"10px"}},X=["aria-valuenow"],Y={class:"d-flex justify-content-between mt-2 small text-muted"},Q={key:4,class:"card mb-5"},Z={class:"card-body"},$={class:"small text-muted"},tt={class:"action-footer bg-white border-top p-2"},et={class:"btn-group w-100 equal-group",role:"group","aria-label":"actions"},st=["disabled"],it=["disabled"],at=["disabled"],nt=["action"],ot=["value"],lt={key:0,class:"cam-overlay"},rt={class:"cam-toolbar"},ct=["disabled"],dt=["disabled"],ut={ref:"videoRef",class:"cam-video",autoplay:"",playsinline:"",muted:""},mt={class:"cam-bottom"},gt=["disabled"];function ht(e,t,a,o,i,n){return c(),r("div",T,[s("header",B,[t[8]||(t[8]=s("div",{class:"d-flex align-items-center"},[s("i",{class:"fas fa-camera-retro me-2"}),s("strong",null,"SNAP GATE")],-1)),s("small",S,"Room: "+d(a.roomCode||"-"),1)]),s("main",U,[a.expiresAt?(c(),r("div",j,[t[9]||(t[9]=s("i",{class:"far fa-clock me-2"},null,-1)),t[10]||(t[10]=u(" この招待は ")),s("strong",null,d(n.humanExp),1),t[11]||(t[11]=u(" まで有効です "))])):g("",!0),s("div",M,[s("div",F,[t[12]||(t[12]=s("p",{class:"mb-2 small text-muted"},"カメラで撮影するか、端末の写真から選択してください。",-1)),s("ul",R,[s("li",null,"最大 "+d(a.maxFiles)+" 枚まで",1),s("li",null,"1枚あたり "+d(a.maxMB)+" MB まで",1)])])]),s("div",L,[s("div",A,[s("button",{type:"button",class:"btn btn-outline-primary btn-lg py-3 w-100 mb-2",onClick:t[0]||(t[0]=(...l)=>n.openCamera&&n.openCamera(...l)),disabled:i.uploading},t[13]||(t[13]=[s("i",{class:"fas fa-video me-2"},null,-1),u(" ライブカメラで撮影 ")]),8,E),s("label",O,[t[14]||(t[14]=s("i",{class:"fas fa-camera me-2"},null,-1)),t[15]||(t[15]=u(" 写真を選択（端末） ")),s("input",{ref:"fileInput",type:"file",class:"d-none",accept:"image/*",capture:"environment",multiple:"",onChange:t[1]||(t[1]=(...l)=>n.onPick&&n.onPick(...l))},null,544)])])]),i.files.length?(c(),r("div",P,[s("div",I,[s("div",D,[s("div",null,[s("strong",null,d(i.files.length),1),u(" / "+d(a.maxFiles)+" 枚 ",1),s("span",N," 合計 "+d((n.totalBytes/1024/1024).toFixed(2))+" MB ",1)]),s("div",null,[s("span",{class:p(["badge",n.okToUpload?"bg-success":"bg-danger"])},d(n.okToUpload?"OK":"上限超過あり"),3)])])])])):g("",!0),i.files.length?(c(),r("div",q,[s("div",z,[(c(!0),r(v,null,w(i.files,(l,m)=>(c(),r("div",{key:l.id,class:"col-4"},[s("div",H,[l.previewable?(c(),r("img",{key:0,class:"w-100 thumb-img",src:l.url,alt:l.file.name},null,8,W)):(c(),r("div",K,t[16]||(t[16]=[s("i",{class:"far fa-file-image fa-2x text-muted"},null,-1)]))),s("span",{class:p(["badge position-absolute top-0 start-0 m-1",l.tooBig?"bg-danger":"bg-dark"]),style:{"z-index":"4"}},d((l.file.size/1024/1024).toFixed(1))+"MB ",3),s("button",{type:"button",class:"remove-btn",onClick:k(f=>n.removeAt(m),["stop","prevent"]),disabled:i.uploading,"aria-label":`remove ${l.file.name}`,title:"削除"},t[17]||(t[17]=[s("i",{class:"fas fa-times","aria-hidden":"true"},null,-1),s("span",{class:"sr-only"},"×",-1)]),8,V)])]))),128))])])):g("",!0),i.uploading?(c(),r("div",G,[s("div",J,[s("div",{class:"progress-bar progress-bar-striped progress-bar-animated",role:"progressbar",style:x({width:i.progress+"%"}),"aria-valuenow":i.progress,"aria-valuemin":"0","aria-valuemax":"100"},null,12,X)]),s("div",Y,[t[18]||(t[18]=s("span",null,"アップロード中…",-1)),s("span",null,d(i.progress)+"%",1)])])):g("",!0),i.result?(c(),r("div",Q,[s("div",Z,[t[19]||(t[19]=s("div",{class:"d-flex align-items-center mb-2"},[s("i",{class:"fas fa-check-circle text-success me-2"}),s("strong",{class:"text-success"},"アップロード完了")],-1)),s("div",$,"保存数: "+d(i.result.count)+" 点",1)])])):g("",!0)]),s("footer",tt,[s("div",et,[s("button",{type:"button",class:"btn btn-outline-warning",onClick:t[2]||(t[2]=(...l)=>n.clearAll&&n.clearAll(...l)),disabled:i.files.length===0||i.uploading},t[20]||(t[20]=[s("i",{class:"fas fa-trash-alt me-1"},null,-1),u(" 全てクリア ")]),8,st),s("button",{type:"button",class:"btn btn-success",disabled:!n.okToUpload||i.uploading||i.files.length===0,onClick:t[3]||(t[3]=(...l)=>n.upload&&n.upload(...l))},t[21]||(t[21]=[s("i",{class:"fas fa-cloud-upload-alt me-1"},null,-1),u(" アップロード ")]),8,it),s("button",{type:"button",class:"btn btn-outline-danger",onClick:t[4]||(t[4]=(...l)=>n.onLogoutClick&&n.onLogoutClick(...l)),disabled:i.uploading},t[22]||(t[22]=[s("i",{class:"fas fa-sign-out-alt me-1"},null,-1),u(" 退出 ")]),8,at)])]),s("form",{ref:"logoutForm",action:a.logoutUrl,method:"post",class:"d-none"},[s("input",{type:"hidden",name:"_token",value:a.csrfToken},null,8,ot)],8,nt),i.camera.open?(c(),r("div",lt,[s("div",rt,[s("button",{type:"button",class:"btn btn-light btn-sm",onClick:t[5]||(t[5]=(...l)=>n.toggleFacing&&n.toggleFacing(...l)),disabled:i.camera.busy},t[23]||(t[23]=[s("i",{class:"fas fa-sync-alt me-1"},null,-1),u(" 切替 ")]),8,ct),s("button",{type:"button",class:"btn btn-outline-light btn-sm",onClick:t[6]||(t[6]=(...l)=>n.closeCamera&&n.closeCamera(...l)),disabled:i.camera.busy},t[24]||(t[24]=[s("i",{class:"fas fa-times me-1"},null,-1),u(" 閉じる ")]),8,dt)]),s("video",ut,null,512),s("div",mt,[s("button",{type:"button",class:"btn btn-primary btn-lg cam-shutter",disabled:i.camera.busy,onClick:t[7]||(t[7]=(...l)=>n.shoot&&n.shoot(...l))},t[25]||(t[25]=[s("i",{class:"fas fa-dot-circle me-2"},null,-1),u(" 撮影 ")]),8,gt)])])):g("",!0)])}const bt=_(C,[["render",ht],["__scopeId","data-v-8a63da6a"]]);export{bt as default};
