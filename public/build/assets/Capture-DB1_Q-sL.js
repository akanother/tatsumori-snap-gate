import{g as y,f as c,o as u,b as s,h as g,t as m,e as d,m as v,n as b,F as x,k as w,p,d as k}from"./app-CfBMEBDv.js";import{_}from"./_plugin-vue_export-helper-DlAUqK2U.js";const T={name:"Capture",components:{Head:y},props:{roomCode:{type:String,default:""},maxFiles:{type:Number,default:10},maxMB:{type:Number,default:20},uploadUrl:{type:String,required:!0},logoutUrl:{type:String,required:!0},expiresAt:{type:String,default:null},csrfToken:{type:String,required:!0}},data(){return{files:[],uploading:!1,progress:0,result:null,camera:{open:!1,facing:"environment",busy:!1,stream:null},pingTimer:null,ui:{flash:!1,shotMark:!1,shutterLock:!1},audio:{ctx:null,unlocked:!1}}},computed:{maxBytes(){return this.maxMB*1024*1024},totalBytes(){return this.files.reduce((e,t)=>{var a;return e+(((a=t.file)==null?void 0:a.size)||0)},0)},okToUpload(){return!(this.files.length===0||this.files.length>this.maxFiles||this.files.some(e=>e.tooBig))},humanExp(){if(!this.expiresAt)return"";try{const e=new Date(this.expiresAt),t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0");return`${t}/${a}/${n} ${i}:${o}`}catch{return this.expiresAt}}},mounted(){this.pingTimer=setInterval(async()=>{try{await fetch("/gate/ping",{method:"GET",credentials:"same-origin",cache:"no-store"})}catch{}},6e4)},beforeUnmount(){var e,t,a;this.pingTimer&&clearInterval(this.pingTimer),this.files.forEach(n=>n.url&&URL.revokeObjectURL(n.url)),this.closeCamera();try{(a=(t=(e=this.audio)==null?void 0:e.ctx)==null?void 0:t.close)==null||a.call(t)}catch{}},methods:{async onPick(e){const t=Array.from(e.target.files||[]);if(!t.length)return;const a=Math.max(this.maxFiles-this.files.length,0),n=t.slice(0,a);for(const i of n){const o=await this.maybeCompress(i);this.pushFile(o,i.name)}this.$refs.fileInput.value="",this.toast(`追加: ${n.length} 枚`)},pushFile(e,t){const a=this.safeName(t,"jpg"),n=new File([e],a,{type:e.type||"image/jpeg"}),i=/image\/(jpeg|png|webp)/.test(n.type),o=n.size>this.maxBytes;this.files.push({id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,file:n,url:i?URL.createObjectURL(n):"",previewable:i,tooBig:o})},removeAt(e){const t=this.files[e];t!=null&&t.url&&URL.revokeObjectURL(t.url),this.files.splice(e,1)},clearAll(){this.files.forEach(e=>e.url&&URL.revokeObjectURL(e.url)),this.files=[],this.result=null,this.progress=0},async upload(){var t;if(!this.okToUpload||this.uploading)return;this.uploading=!0,this.progress=0,this.result=null;const e=new FormData;this.files.forEach(a=>e.append("images[]",a.file)),e.append("_token",this.csrfToken);try{const a=await this.xhrPost(this.uploadUrl,e,i=>{i.lengthComputable&&(this.progress=Math.min(100,Math.round(i.loaded/i.total*100)))});if(!a.ok){const i=await this.safeJson(a);throw new Error((i==null?void 0:i.message)||`HTTP ${a.status}`)}this.result=await a.json();const n=((t=this.result)==null?void 0:t.count)??this.files.length;this.clearAll(),await p.fire({icon:"success",title:"アップロード完了",html:`<div style="line-height:1.6">保存数：<b>${n}</b> 点<br>ご協力ありがとうございます。</div>`,confirmButtonText:"OK"})}catch(a){console.error(a),p.fire({icon:"error",title:"アップロードに失敗しました",text:a&&a.message?String(a.message):"未知のエラーです",confirmButtonText:"閉じる"})}finally{this.uploading=!1,this.progress=0}},xhrPost(e,t,a){return new Promise((n,i)=>{const o=new XMLHttpRequest;o.open("POST",e),o.responseType="json",o.setRequestHeader("X-CSRF-TOKEN",this.csrfToken),o.upload.onprogress=a,o.onload=()=>{n({ok:o.status>=200&&o.status<300,status:o.status,json:async()=>o.response})},o.onerror=()=>i(new Error("ネットワークエラー")),o.send(t)})},async safeJson(e){try{return await e.json()}catch{return null}},onLogoutClick(){if(confirm("退出するとこのセッションは終了します。よろしいですか？")){try{history.replaceState(null,"","/gate/ended")}catch{}this.$refs.logoutForm.submit()}},toast(e="完了",t="success"){return p.mixin({toast:!0,position:"top",showConfirmButton:!1,timer:1800,timerProgressBar:!0}).fire({icon:t,title:e})},async ensureAudioUnlocked(){if(!this.audio.unlocked)try{const e=window.AudioContext||window.webkitAudioContext;if(!e)return;this.audio.ctx=new e;const t=this.audio.ctx.createOscillator(),a=this.audio.ctx.createGain();a.gain.value=1e-4,t.connect(a).connect(this.audio.ctx.destination),t.start(),t.stop(this.audio.ctx.currentTime+.02),this.audio.unlocked=!0}catch{}},playShutter(){var n;if(!((n=this.audio)!=null&&n.ctx))return;const e=this.audio.ctx,t=e.currentTime,a=(i,o,l,r=.15)=>{const h=e.createOscillator(),f=e.createGain();h.type="square",h.frequency.setValueAtTime(i,t+o),f.gain.setValueAtTime(1e-4,t+o),f.gain.exponentialRampToValueAtTime(r,t+o+.01),f.gain.exponentialRampToValueAtTime(1e-4,t+o+l),h.connect(f).connect(e.destination),h.start(t+o),h.stop(t+o+l+.02)};a(1800,0,.06),a(900,.05,.08)},triggerFlash(){this.ui.flash=!0,setTimeout(()=>this.ui.flash=!1,120)},showShotMark(){this.ui.shotMark=!0,setTimeout(()=>this.ui.shotMark=!1,600)},announce(e){this.$refs.liveRegion&&(this.$refs.liveRegion.textContent=e)},async openCamera(){var e;if(!((e=navigator.mediaDevices)!=null&&e.getUserMedia)){p.fire({icon:"info",title:"カメラ非対応",text:"写真の選択をご利用ください。"});return}try{this.camera.busy=!0,await this.ensureAudioUnlocked();const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:this.camera.facing,width:{ideal:1920},height:{ideal:1080}},audio:!1});this.camera.stream=t,this.camera.open=!0,await this.$nextTick();const a=this.$refs.videoRef;a.srcObject=t,await a.play(),this.announce("カメラを起動しました")}catch(t){console.error(t),p.fire({icon:"error",title:"カメラを起動できません",text:"権限設定をご確認ください。"})}finally{this.camera.busy=!1}},async closeCamera(){this.camera.stream&&(this.camera.stream.getTracks().forEach(e=>e.stop()),this.camera.stream=null),this.camera.open=!1},async toggleFacing(){this.camera.facing=this.camera.facing==="environment"?"user":"environment",await this.closeCamera(),await this.openCamera()},async shoot(){if(!(!this.camera.open||this.ui.shutterLock)){this.ui.shutterLock=!0,this.camera.busy=!0;try{this.triggerFlash(),navigator.vibrate&&navigator.vibrate(35),this.playShutter();const e=this.$refs.videoRef,t=e.videoWidth||1280,a=e.videoHeight||720,n=document.createElement("canvas"),{tw:i,th:o}=this.fitWithin(t,a,2e3,2e3);n.width=i,n.height=o,n.getContext("2d").drawImage(e,0,0,i,o);let r=.92,h=await this.canvasToBlob(n,"image/jpeg",r);for(;h.size>this.maxBytes&&r>.5;)r-=.08,h=await this.canvasToBlob(n,"image/jpeg",r);const f=`camera_${this.ts()}_${Math.random().toString(36).slice(2,8)}.jpg`;this.pushFile(h,f),this.showShotMark(),this.announce("撮影しました"),this.toast("撮影しました")}catch(e){console.error(e),p.fire({icon:"error",title:"撮影に失敗しました",text:"もう一度お試しください。"})}finally{this.camera.busy=!1,setTimeout(()=>this.ui.shutterLock=!1,350)}}},safeName(e,t="jpg"){return(e||"").replace(/[^\w.\-]+/g,"_")||`image_${this.ts()}.${t}`},ts(){const e=new Date,t=a=>String(a).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}_${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`},fitWithin(e,t,a,n){const i=Math.min(a/e,n/t,1);return{tw:Math.round(e*i),th:Math.round(t*i)}},canvasToBlob(e,t,a){return new Promise(n=>e.toBlob(i=>n(i),t,a))},async maybeCompress(e){if(/image\/(heic|heif)/i.test(e.type))return e;try{const t=await this.readImage(e),{tw:a,th:n}=this.fitWithin(t.width,t.height,2e3,2e3),i=document.createElement("canvas");i.width=a,i.height=n,i.getContext("2d").drawImage(t,0,0,a,n);let l=.92,r=await this.canvasToBlob(i,"image/jpeg",l);for(;r.size>this.maxBytes&&l>.5;)l-=.08,r=await this.canvasToBlob(i,"image/jpeg",l);return r}catch(t){return console.warn("compress failed, use original",t),e}},readImage(e){return new Promise((t,a)=>{const n=URL.createObjectURL(e),i=new Image;i.onload=()=>{URL.revokeObjectURL(n),t(i)},i.onerror=o=>{URL.revokeObjectURL(n),a(o)},i.src=n})}}},C={class:"bg-gray-50 min-h-screen d-flex flex-column"},S={class:"p-3 bg-white shadow-sm d-flex align-items-center justify-content-between sticky-top"},M={class:"text-muted"},B={class:"container py-3 with-footer",style:{"max-width":"640px"}},U={key:0,class:"alert alert-info py-2 px-3 mb-3"},R={key:1,class:"upload-progress-wrap mb-3"},j={class:"progress"},F=["aria-valuenow"],L={class:"d-flex justify-content-between mt-1 small text-muted"},A={class:"card mb-3"},E={class:"card-body py-3"},O={class:"small mb-0 text-muted ps-3"},P={class:"card mb-3"},q={class:"card-body d-grid gap-2"},I=["disabled"],D={class:"btn btn-primary btn-lg py-3 w-100 mb-0"},N={key:2,class:"card mb-3"},z={class:"card-body py-3"},H={class:"d-flex justify-content-between align-items-center"},V={class:"text-muted small ms-2"},G={key:3,class:"mb-3"},W={class:"row g-2"},K={class:"thumb border rounded overflow-hidden"},J=["src","alt"],X={key:1,class:"thumb-fallback"},Y=["onClick","disabled","aria-label"],Q={key:4,class:"card mb-5"},Z={class:"card-body"},$={class:"small text-muted"},tt={class:"action-footer bg-white border-top p-2"},et={class:"btn-group w-100 equal-group",role:"group","aria-label":"actions"},st=["disabled"],it=["disabled"],at=["disabled"],ot=["action"],nt=["value"],lt={key:0,class:"cam-overlay"},rt={class:"cam-toolbar"},ct=["disabled"],ut=["disabled"],dt={ref:"videoRef",class:"cam-video",autoplay:"",playsinline:"",muted:""},mt={class:"cam-bottom"},ht=["disabled"],gt={key:0,class:"shot-mark"},ft={class:"sr-only","aria-live":"polite",ref:"liveRegion"};function pt(e,t,a,n,i,o){return u(),c("div",C,[s("header",S,[t[8]||(t[8]=s("div",{class:"d-flex align-items-center"},[s("i",{class:"fas fa-camera-retro me-2"}),s("strong",null,"SNAP GATE")],-1)),s("small",M,"Room: "+m(a.roomCode||"-"),1)]),s("main",B,[a.expiresAt?(u(),c("div",U,[t[9]||(t[9]=s("i",{class:"far fa-clock me-2"},null,-1)),t[10]||(t[10]=d(" この招待は ")),s("strong",null,m(o.humanExp),1),t[11]||(t[11]=d(" まで有効です "))])):g("",!0),i.uploading?(u(),c("div",R,[s("div",j,[s("div",{class:"progress-bar progress-bar-striped progress-bar-animated",role:"progressbar",style:v({width:i.progress+"%"}),"aria-valuenow":i.progress,"aria-valuemin":"0","aria-valuemax":"100"},null,12,F)]),s("div",L,[t[12]||(t[12]=s("span",null,"アップロード中…",-1)),s("span",null,m(i.progress)+"%",1)])])):g("",!0),s("div",A,[s("div",E,[t[13]||(t[13]=s("p",{class:"mb-2 small text-muted"},"カメラで撮影するか、端末の写真から選択してください。",-1)),s("ul",O,[s("li",null,"最大 "+m(a.maxFiles)+" 枚まで",1),s("li",null,"1枚あたり "+m(a.maxMB)+" MB まで",1)])])]),s("div",P,[s("div",q,[s("button",{type:"button",class:"btn btn-outline-primary btn-lg py-3 w-100 mb-2",onClick:t[0]||(t[0]=(...l)=>o.openCamera&&o.openCamera(...l)),disabled:i.uploading},t[14]||(t[14]=[s("i",{class:"fas fa-video me-2"},null,-1),d(" ライブカメラで撮影 ")]),8,I),s("label",D,[t[15]||(t[15]=s("i",{class:"fas fa-camera me-2"},null,-1)),t[16]||(t[16]=d(" 写真を選択（端末） ")),s("input",{ref:"fileInput",type:"file",class:"d-none",accept:"image/*",multiple:"",onChange:t[1]||(t[1]=(...l)=>o.onPick&&o.onPick(...l))},null,544)])])]),i.files.length?(u(),c("div",N,[s("div",z,[s("div",H,[s("div",null,[s("strong",null,m(i.files.length),1),d(" / "+m(a.maxFiles)+" 枚 ",1),s("span",V," 合計 "+m((o.totalBytes/1024/1024).toFixed(2))+" MB ",1)]),s("div",null,[s("span",{class:b(["badge",o.okToUpload?"bg-success":"bg-danger"])},m(o.okToUpload?"OK":"上限超過あり"),3)])])])])):g("",!0),i.files.length?(u(),c("div",G,[s("div",W,[(u(!0),c(x,null,w(i.files,(l,r)=>(u(),c("div",{key:l.id,class:"col-4"},[s("div",K,[l.previewable?(u(),c("img",{key:0,class:"w-100 thumb-img",src:l.url,alt:l.file.name},null,8,J)):(u(),c("div",X,t[17]||(t[17]=[s("i",{class:"far fa-file-image fa-2x text-muted"},null,-1)]))),s("span",{class:b(["badge position-absolute top-0 start-0 m-1",l.tooBig?"bg-danger":"bg-dark"]),style:{"z-index":"4"}},m((l.file.size/1024/1024).toFixed(1))+"MB ",3),s("button",{type:"button",class:"remove-btn",onClick:k(h=>o.removeAt(r),["stop","prevent"]),disabled:i.uploading,"aria-label":`remove ${l.file.name}`,title:"削除"},t[18]||(t[18]=[s("i",{class:"fas fa-times","aria-hidden":"true"},null,-1),s("span",{class:"sr-only"},"×",-1)]),8,Y)])]))),128))])])):g("",!0),i.result?(u(),c("div",Q,[s("div",Z,[t[19]||(t[19]=s("div",{class:"d-flex align-items-center mb-2"},[s("i",{class:"fas fa-check-circle text-success me-2"}),s("strong",{class:"text-success"},"アップロード完了")],-1)),s("div",$,"保存数: "+m(i.result.count)+" 点",1)])])):g("",!0)]),s("footer",tt,[s("div",et,[s("button",{type:"button",class:"btn btn-outline-warning",onClick:t[2]||(t[2]=(...l)=>o.clearAll&&o.clearAll(...l)),disabled:i.files.length===0||i.uploading},t[20]||(t[20]=[s("i",{class:"fas fa-trash-alt me-1"},null,-1),d(" 全てクリア ")]),8,st),s("button",{type:"button",class:"btn btn-success",disabled:!o.okToUpload||i.uploading||i.files.length===0,onClick:t[3]||(t[3]=(...l)=>o.upload&&o.upload(...l))},t[21]||(t[21]=[s("i",{class:"fas fa-cloud-upload-alt me-1"},null,-1),d(" アップロード ")]),8,it),s("button",{type:"button",class:"btn btn-outline-danger",onClick:t[4]||(t[4]=(...l)=>o.onLogoutClick&&o.onLogoutClick(...l)),disabled:i.uploading},t[22]||(t[22]=[s("i",{class:"fas fa-sign-out-alt me-1"},null,-1),d(" 退出 ")]),8,at)])]),s("form",{ref:"logoutForm",action:a.logoutUrl,method:"post",class:"d-none"},[s("input",{type:"hidden",name:"_token",value:a.csrfToken},null,8,nt)],8,ot),i.camera.open?(u(),c("div",lt,[s("div",rt,[s("button",{type:"button",class:"btn btn-light btn-sm",onClick:t[5]||(t[5]=(...l)=>o.toggleFacing&&o.toggleFacing(...l)),disabled:i.camera.busy},t[23]||(t[23]=[s("i",{class:"fas fa-sync-alt me-1"},null,-1),d(" 切替 ")]),8,ct),s("button",{type:"button",class:"btn btn-outline-light btn-sm",onClick:t[6]||(t[6]=(...l)=>o.closeCamera&&o.closeCamera(...l)),disabled:i.camera.busy},t[24]||(t[24]=[s("i",{class:"fas fa-times me-1"},null,-1),d(" 閉じる ")]),8,ut)]),s("video",dt,null,512),s("div",mt,[s("button",{type:"button",class:"btn btn-primary btn-lg cam-shutter",disabled:i.camera.busy||i.ui.shutterLock,onClick:t[7]||(t[7]=(...l)=>o.shoot&&o.shoot(...l))},t[25]||(t[25]=[s("i",{class:"fas fa-dot-circle me-2"},null,-1),d(" 撮影 ")]),8,ht)]),s("div",{class:b(["flash",{active:i.ui.flash}])},null,2),i.ui.shotMark?(u(),c("div",gt,t[26]||(t[26]=[s("i",{class:"fas fa-check-circle me-2"},null,-1),d(" 撮影しました ")]))):g("",!0),s("div",ft,null,512)])):g("",!0)])}const vt=_(T,[["render",pt],["__scopeId","data-v-062353a3"]]);export{vt as default};
