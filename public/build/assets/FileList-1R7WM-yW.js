import{g as u,p as h}from"./app-DNec1a2P.js";/* empty css                        */import{_ as m}from"./_plugin-vue_export-helper-DlAUqK2U.js";const g={name:"Capture",components:{Head:u},props:{roomCode:{type:String,default:""},maxFiles:{type:Number,default:10},maxMB:{type:Number,default:20},uploadUrl:{type:String,required:!0},logoutUrl:{type:String,required:!0},expiresAt:{type:String,default:null},csrfToken:{type:String,required:!0}},data(){return{files:[],uploading:!1,progress:0,result:null,camera:{open:!1,facing:"environment",busy:!1,stream:null},pingTimer:null,ui:{flash:!1,shotMark:!1,shutterLock:!1},audio:{ctx:null,unlocked:!1}}},computed:{maxBytes(){return this.maxMB*1024*1024},totalBytes(){return this.files.reduce((t,e)=>{var s;return t+(((s=e.file)==null?void 0:s.size)||0)},0)},okToUpload(){return!(this.files.length===0||this.files.length>this.maxFiles||this.files.some(t=>t.tooBig))},humanExp(){if(!this.expiresAt)return"";try{const t=new Date(this.expiresAt),e=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),i=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0");return`${e}/${s}/${a} ${i}:${r}`}catch{return this.expiresAt}}},mounted(){this.pingTimer=setInterval(async()=>{try{await fetch("/gate/ping",{method:"GET",credentials:"same-origin",cache:"no-store"})}catch{}},6e4)},beforeUnmount(){var t,e,s;this.pingTimer&&clearInterval(this.pingTimer),this.files.forEach(a=>a.url&&URL.revokeObjectURL(a.url)),this.closeCamera();try{(s=(e=(t=this.audio)==null?void 0:t.ctx)==null?void 0:e.close)==null||s.call(e)}catch{}},methods:{async onPick(t){const e=Array.from(t.target.files||[]);if(!e.length)return;const s=Math.max(this.maxFiles-this.files.length,0),a=e.slice(0,s);for(const i of a){const r=await this.maybeCompress(i);this.pushFile(r,i.name)}this.$refs.fileInput.value="",this.toast(`追加: ${a.length} 枚`)},pushFile(t,e){const s=this.safeName(e,"jpg"),a=new File([t],s,{type:t.type||"image/jpeg"}),i=/image\/(jpeg|png|webp)/.test(a.type),r=a.size>this.maxBytes;this.files.push({id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,file:a,url:i?URL.createObjectURL(a):"",previewable:i,tooBig:r})},removeAt(t){const e=this.files[t];e!=null&&e.url&&URL.revokeObjectURL(e.url),this.files.splice(t,1)},clearAll(){this.files.forEach(t=>t.url&&URL.revokeObjectURL(t.url)),this.files=[],this.result=null,this.progress=0},async upload(){var e;if(!this.okToUpload||this.uploading)return;this.uploading=!0,this.progress=0,this.result=null;const t=new FormData;this.files.forEach(s=>t.append("images[]",s.file)),t.append("_token",this.csrfToken);try{const s=await this.xhrPost(this.uploadUrl,t,i=>{i.lengthComputable&&(this.progress=Math.min(100,Math.round(i.loaded/i.total*100)))});if(!s.ok){const i=await this.safeJson(s);throw new Error((i==null?void 0:i.message)||`HTTP ${s.status}`)}this.result=await s.json();const a=((e=this.result)==null?void 0:e.count)??this.files.length;this.clearAll(),await h.fire({icon:"success",title:"アップロード完了",html:`<div style="line-height:1.6">保存数：<b>${a}</b> 点<br>ご協力ありがとうございます。</div>`,confirmButtonText:"OK"})}catch(s){console.error(s),h.fire({icon:"error",title:"アップロードに失敗しました",text:s&&s.message?String(s.message):"未知のエラーです",confirmButtonText:"閉じる"})}finally{this.uploading=!1,this.progress=0}},xhrPost(t,e,s){return new Promise((a,i)=>{const r=new XMLHttpRequest;r.open("POST",t),r.responseType="json",r.setRequestHeader("X-CSRF-TOKEN",this.csrfToken),r.upload.onprogress=s,r.onload=()=>{a({ok:r.status>=200&&r.status<300,status:r.status,json:async()=>r.response})},r.onerror=()=>i(new Error("ネットワークエラー")),r.send(e)})},async safeJson(t){try{return await t.json()}catch{return null}},onLogoutClick(){if(confirm("退出するとこのセッションは終了します。よろしいですか？")){try{history.replaceState(null,"","/gate/ended")}catch{}this.$refs.logoutForm.submit()}},toast(t="完了",e="success"){return h.mixin({toast:!0,position:"top",showConfirmButton:!1,timer:1800,timerProgressBar:!0}).fire({icon:e,title:t})},async ensureAudioUnlocked(){if(!this.audio.unlocked)try{const t=window.AudioContext||window.webkitAudioContext;if(!t)return;this.audio.ctx=new t;const e=this.audio.ctx.createOscillator(),s=this.audio.ctx.createGain();s.gain.value=1e-4,e.connect(s).connect(this.audio.ctx.destination),e.start(),e.stop(this.audio.ctx.currentTime+.02),this.audio.unlocked=!0}catch{}},playShutter(){var a;if(!((a=this.audio)!=null&&a.ctx))return;const t=this.audio.ctx,e=t.currentTime,s=(i,r,c,o=.15)=>{const n=t.createOscillator(),l=t.createGain();n.type="square",n.frequency.setValueAtTime(i,e+r),l.gain.setValueAtTime(1e-4,e+r),l.gain.exponentialRampToValueAtTime(o,e+r+.01),l.gain.exponentialRampToValueAtTime(1e-4,e+r+c),n.connect(l).connect(t.destination),n.start(e+r),n.stop(e+r+c+.02)};s(1800,0,.06),s(900,.05,.08)},triggerFlash(){this.ui.flash=!0,setTimeout(()=>this.ui.flash=!1,120)},showShotMark(){this.ui.shotMark=!0,setTimeout(()=>this.ui.shotMark=!1,600)},announce(t){this.$refs.liveRegion&&(this.$refs.liveRegion.textContent=t)},async openCamera(){var t;if(!((t=navigator.mediaDevices)!=null&&t.getUserMedia)){h.fire({icon:"info",title:"カメラ非対応",text:"写真の選択をご利用ください。"});return}try{this.camera.busy=!0,await this.ensureAudioUnlocked();const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:this.camera.facing,width:{ideal:1920},height:{ideal:1080}},audio:!1});this.camera.stream=e,this.camera.open=!0,await this.$nextTick();const s=this.$refs.videoRef;s.srcObject=e,await s.play(),this.announce("カメラを起動しました")}catch(e){console.error(e),h.fire({icon:"error",title:"カメラを起動できません",text:"権限設定をご確認ください。"})}finally{this.camera.busy=!1}},async closeCamera(){this.camera.stream&&(this.camera.stream.getTracks().forEach(t=>t.stop()),this.camera.stream=null),this.camera.open=!1},async toggleFacing(){this.camera.facing=this.camera.facing==="environment"?"user":"environment",await this.closeCamera(),await this.openCamera()},async shoot(){if(!(!this.camera.open||this.ui.shutterLock)){this.ui.shutterLock=!0,this.camera.busy=!0;try{this.triggerFlash(),navigator.vibrate&&navigator.vibrate(35),this.playShutter();const t=this.$refs.videoRef,e=t.videoWidth||1280,s=t.videoHeight||720,a=document.createElement("canvas"),{tw:i,th:r}=this.fitWithin(e,s,2e3,2e3);a.width=i,a.height=r,a.getContext("2d").drawImage(t,0,0,i,r);let o=.92,n=await this.canvasToBlob(a,"image/jpeg",o);for(;n.size>this.maxBytes&&o>.5;)o-=.08,n=await this.canvasToBlob(a,"image/jpeg",o);const l=`camera_${this.ts()}_${Math.random().toString(36).slice(2,8)}.jpg`;this.pushFile(n,l),this.showShotMark(),this.announce("撮影しました"),this.toast("撮影しました")}catch(t){console.error(t),h.fire({icon:"error",title:"撮影に失敗しました",text:"もう一度お試しください。"})}finally{this.camera.busy=!1,setTimeout(()=>this.ui.shutterLock=!1,350)}}},safeName(t,e="jpg"){return(t||"").replace(/[^\w.\-]+/g,"_")||`image_${this.ts()}.${e}`},ts(){const t=new Date,e=s=>String(s).padStart(2,"0");return`${t.getFullYear()}${e(t.getMonth()+1)}${e(t.getDate())}_${e(t.getHours())}${e(t.getMinutes())}${e(t.getSeconds())}`},fitWithin(t,e,s,a){const i=Math.min(s/t,a/e,1);return{tw:Math.round(t*i),th:Math.round(e*i)}},canvasToBlob(t,e,s){return new Promise(a=>t.toBlob(i=>a(i),e,s))},async maybeCompress(t){if(/image\/(heic|heif)/i.test(t.type))return t;try{const e=await this.readImage(t),{tw:s,th:a}=this.fitWithin(e.width,e.height,2e3,2e3),i=document.createElement("canvas");i.width=s,i.height=a,i.getContext("2d").drawImage(e,0,0,s,a);let c=.92,o=await this.canvasToBlob(i,"image/jpeg",c);for(;o.size>this.maxBytes&&c>.5;)c-=.08,o=await this.canvasToBlob(i,"image/jpeg",c);return o}catch(e){return console.warn("compress failed, use original",e),t}},readImage(t){return new Promise((e,s)=>{const a=URL.createObjectURL(t),i=new Image;i.onload=()=>{URL.revokeObjectURL(a),e(i)},i.onerror=r=>{URL.revokeObjectURL(a),s(r)},i.src=a})}}};function f(t,e,s,a,i,r){return null}const w=m(g,[["render",f],["__scopeId","data-v-dfb80eca"]]);export{w as default};
